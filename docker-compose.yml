version: '3'

volumes:
  database_data:
    driver: local

services:
  nginx:
    image: nginx:latest
    restart: "no"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled
      - ./nginx/sites.template:/etc/nginx/sites-available/sites.template
      - ./nginx/default/html:/var/www/html
      - ./nginx/log/nginx:/var/log/nginx
      - ./nginx/letsencrypt/:/etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"
    environment:
      - NGINX_DOMAIN=${DOMAIN_SUB:-lab}.${DOMAIN_ROOT:-bigbluebutton.org}
    depends_on:
      - scalelite
    command: /bin/bash -c "envsubst '$$NGINX_DOMAIN' < /etc/nginx/sites-available/sites.template > /etc/nginx/sites-enabled/sites.conf && exec nginx -g 'daemon off;'"

  redis:
    image: redis
    restart: "no"
    ports:
      - 127.0.0.1:6379:6379
    networks:
      - default
    volumes:
      - ./redis/data/:/data

  scalelite:
    entrypoint: [bin/start]
    image: blindsidenetwks/scalelite:master
    restart: "no"
    ports:
      - 127.0.0.1:3000:3000
    links:
      - redis
    networks:
      - default
    volumes:
      - ./scalelite/log:/usr/src/app/log
      - ./scalelite/bin/start:/usr/src/app/bin/start
      - ./scalelite/tmp/pids/:/usr/src/app/tmp/pids
      - ./scalelite/tmp/sockets/:/usr/src/app/tmp/sockets
      - ./scalelite/tmp/cache/assets:/usr/src/app/tmp/cache/assets
#    logging:
#      driver: syslog
#      options:
#        syslog-address: udp://logs.$DOMAINNAME:1514
#        tag: sl.$DOMAINNAME
    env_file: ./scalelite/.env
    environment:
      - REDIS_URL=redis://redis:6379
      - REDIS_NAMESPACE=scalelite
      - URL_HOST=sl.${DOMAIN_SUB:-lab}.${DOMAIN_ROOT:-bigbluebutton.org}
